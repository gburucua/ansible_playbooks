---
- name: Create a VM from a template with two network interfaces
  hosts: localhost
  gather_facts: no
  collections:
    - community.vmware

  tasks:
    - name: Deploy a VM from template with 2 NICs
      vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        validate_certs: "{{ validate_certs | default(false) }}"
        datacenter: "HST"
        folder: "/HST/vm/ROOT-VPS-CLIENTS/MTSI"
        name: "{{ vm_name }}"
        template: "{{ vm_template }}"
        cluster: "VPS"
        resource_pool: "ROOT-VPS-CLIENTS"
        state: poweredon
        networks:
          - name: "dVLAN-PROD-133"
            type: static
            ip: "{{ vm_ip }}"
            netmask: "255.255.255.128"
            gateway: "80.94.97.1"
            start_connected: true
          - name: "dVLAN-ADMIN-1366"
            type: dhcp
            start_connected: true
        hardware:
          memory_mb: "{{ vm_memory }}"
          num_cpus: "{{ vm_cpu }}"
        customization:
          hostname: "{{ vm_name }}"
          domain: "prod.lan"
          dns_servers:
            - 195.78.26.211
            - 195.78.26.210
      register: deploy_result
    
    - name: Wait for SSH to be available on the new VM
      wait_for:
      host: "{{ vm_ip }}"
      port: 22
      timeout: 300
      state: started
    
    - name: Configure static route via SSH from localhost
      ansible.builtin.shell: >
        ssh -o StrictHostKeyChecking=no debian@{{ vm_ip }}
        "sudo ip route add 172.22.0.0/16 via 172.23.28.129 dev ens192 metric 110"
      delegate_to: localhost
