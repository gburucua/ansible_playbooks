---
- name: Create a VM from a template
  hosts: localhost
  gather_facts: no
  collections:
    - community.vmware

  vars:
    vcenter_hostname: "10.100.39.2"
    vcenter_username: "g.burucuasrvadm"
    vcenter_password: "ElcucuGerardin1390$"
    validate_certs: false
    vm_name: "new-vm-from-awx"

  tasks:
    - name: Deploy a VM from template
      vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ validate_certs }}"
        datacenter: "HST"
        folder: "/HST/vm/ROOT-VPS-CLIENTS/PROD-VPS"
        name: "{{ vm_name }}"
        template: "ubuntu24"
        cluster: "VPS"
        resource_pool: "ROOT-VPS-CLIENTS"
        state: poweredon
        networks:
          - name: "dVLAN-PROD-133"
            type: static
            ip: "80.94.97.11"
            netmask: "255.255.255.128"
            gateway: "80.94.97.1"
        hardware:
          memory_mb: 2048
          num_cpus: 2
        customization:
          hostname: "testgb-awx"
          domain: "prod.lan"
      register: deploy_result

    - name: Wait for VM tools to start and IP to become available
      vmware_guest_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: false
        datacenter: "HST"
        name: "{{ vm_name }}"
      register: vm_info
      retries: 10
      delay: 15
      until: vm_info.instance.ip_address is defined and vm_info.instance.ip_address != ""

    - name: Show the VM's IP address
      debug:
        msg: "The IP address of the VM is: {{ vm_info.instance.ip_address }}"
